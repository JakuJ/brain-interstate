module CompileSpec where

import System.IO (writeFile)
import System.Directory (removeFile)
import System.Process (callProcess, readProcess)
import System.Environment (withArgs)
    
import Test.Hspec
import Compile (runCompiler)
    
writeTmp :: String -> IO ()
writeTmp = writeFile "test-source.txt"

cleanup :: IO ()
cleanup = do
    removeFile "test-source.txt"
    removeFile "test.exe"

testCompile :: String -> IO ()
testCompile source = do
    writeTmp source
    withArgs ["-o", "test.exe", "test-source.txt"] runCompiler

testRun :: String -> IO String
testRun input = do
    callProcess "chmod" ["+x", "./test.exe"]
    readProcess "./test.exe" [] input

spec :: Spec
spec = after_ cleanup $ do
    describe "Compile.runCompiler" $ do
        context "when given good filepaths" $ do
            it "compiles and runs a hello world" $ do
                testCompile helloWorld
                testRun "" `shouldReturn` "Hello World!\n"
            it "compiles and runs a cat program" $ do
                testCompile cat
                let testString = "abcDEF123"
                testRun (testString) `shouldReturn` testString
            it "compiles and runs a digit factorial calculator" $ do
                testCompile factorial
                testRun "5" `shouldReturn` "x" -- 'x' is ASCII for 120 (5 factorial)
            it "compiles a brainfuck interpreter" $ do
                testCompile interpreter
                hwCode <- testRun (helloWorld ++ "x")
                writeFile "test-source.c" hwCode
                callProcess "gcc" ["-w", "-o", "test.exe", "test-source.c"]
                removeFile "test-source.c"
                testRun "" `shouldReturn` "Hello World!\n"

-- Brainfuck programs

helloWorld :: String
helloWorld = "++++++++++[>+++++++>++++++++++>+++>+<<<<-]>++.>+.+++++++..+++.>++.<<+++++++++++++++.>.+++.------.--------.>+.>."

cat :: String
cat = ",[.,]"

factorial :: String
factorial = "++++++>,<[->--------<]>[[>>+>+<<<-]>>>-]+<[>[<[<+<+>>-]<[>+<-]>>-]<<<<]>."

interpreter :: String
interpreter = "\
\>+++++[>+++++++<-]>.<<++[>+++++[>+++++++<-]<-]>>.+++++.<++[>-----<-]>-.<++\
\[>++++<-]>+.<++[>++++<-]>+.[>+>+>+<<<-]>>>[<<<+>>>-]<<<<<++[>+++[>---<-]<-\
\]>>+.+.<+++++++[>----------<-]>+.<++++[>+++++++<-]>.>.-------.-----.<<++[>\
\>+++++<<-]>>.+.----------------.<<++[>-------<-]>.>++++.<<++[>++++++++<-]>\
\.<++++++++++[>>>-----------<<<-]>>>+++.<-----.+++++.-------.<<++[>>+++++++\
\+<<-]>>+.<<+++[>----------<-]>.<++[>>--------<<-]>>-.------.<<++[>++++++++\
\<-]>+++.---....>++.<----.--.<++[>>+++++++++<<-]>>+.<<++[>+++++++++<-]>+.<+\
\+[>>-------<<-]>>-.<--.>>.<<<+++[>>++++<<-]>>.<<+++[>>----<<-]>>.++++++++.\
\+++++.<<++[>---------<-]>-.+.>>.<<<++[>>+++++++<<-]>>-.>.>>>[-]>>[-]<+[<<[\
\-],[>>>>>>>>>>>>>+>+<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>[<<<<<<<<<<<<<<+>>>>>>>>\
\>>>>>>-]<<+>[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-[-\
\[-[-[-[-[-[-[-[-[-[-[-[<->[-]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]<[\
\<<<<<<<<<<<<[-]>>>>>>>>>>>>[-]]<<<<<<<<<<<<[<+++++[>---------<-]>++[>]>>[>\
\+++++[>+++++++++<-]>--..-.<+++++++[>++++++++++<-]>.<+++++++++++[>-----<-]>\
\++.<<<<<<.>>>>>>[-]<]<<<[-[>]>>[>++++++[>+++[>++++++<-]<-]>>++++++.-------\
\------.----.+++.<++++++[>----------<-]>.++++++++.----.<++++[>+++++++++++++\
\++++<-]>.<++++[>-----------------<-]>.+++++.--------.<++[>+++++++++<-]>.[-\
\]<<<<<<<.>>>>>]<<<[-[>]>>[>+++++[>+++++++++<-]>..---.<+++++++[>++++++++++<\
\-]>.<+++++++++++[>-----<-]>++.<<<<<<.>>>>>>[-]<]<<<[-[>]>>[>+++[>++++[>+++\
\+++++++<-]<-]>>-.-----.---------.<++[>++++++<-]>-.<+++[>-----<-]>.<++++++[\
\>----------<-]>-.<+++[>+++<-]>.-----.<++++[>+++++++++++++++++<-]>.<++++[>-\
\----------------<-]>.+++++.--------.<++[>+++++++++<-]>.[-]<<<<<<<.>>>>>]<<\
\<[<+++[>-----<-]>+[>]>>[>+++++[>+++++++++<-]>..<+++++++[>++++++++++<-]>---\
\.<+++++[>----------<-]>---.<<<<<<.>>>>>>[-]<]<<<[--[>]>>[>+++++[>+++++++++\
\<-]>--..<+++++++[>++++++++++<-]>-.<+++++[>----------<-]>---.[-]<<<<<<.>>>>\
\>]<<<[<+++[>----------<-]>+[>]>>[>+++[>++++[>++++++++++<-]<-]>>-.<+++[>---\
\--<-]>.+.+++.-------.<++++++[>----------<-]>-.++.<+++++++[>++++++++++<-]>.\
\<+++++++[>----------<-]>-.<++++++++[>++++++++++<-]>++.[-]<<<<<<<.>>>>>]<<<\
\[--[>]>>[>+++++[>+++++[>+++++<-]<-]>>.[-]<<<<<<<.>>>>>]<<<[<++++++++++[>--\
\--------------<-]>--[>]>>[<<<<[-]]]]]]]]]]]>>]<++[>+++++[>++++++++++<-]<-]\
\>>+.<+++[>++++++<-]>+.<+++[>-----<-]>.+++++++++++.<+++++++[>----------<-]>\
\------.++++++++.-------.<+++[>++++++<-]>.<++++++[>+++++++++++<-]>.<+++++++\
\+++."